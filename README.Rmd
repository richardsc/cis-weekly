---
title: "CIS Data Processing"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
knitr::opts_chunk$set(echo = TRUE, dpi = 300, fig.path = "README_")
```

This repo describes a pipeline for turning .zip files downloaded from the [CIS search tool](https://iceweb1.cis.ec.gc.ca/Archive/page1.xhtml) into usable data products that can be queried and loaded efficiently in R. Roughly,

- Add .zip files to zip/
- Run zip-collect.R
- Run gpkg-collect.R
- Run attrs-collect.R

Both zip-collect.R and gpkg-collect.R are sufficiently lazy such that they do not decompress/load anything that has already been converted. The result is a folder gpkg/ that contains easy-to-read (i.e., `sf::read_sf()`) .gpkg files and a highly queryable attribute table (read using `arrow::read_parquet()`).

Alternatively, you can use the provided attrs.parquet and/or zip/meta.csv to download a subset of the data (urls for each data source are provided).

```{r}
library(tidyverse)

read_csv("zip/meta.csv")
```

```{r}
sf::read_sf("gpkg/EA_1968-06-25.gpkg")
```

```{r}
arrow::read_parquet("attrs.parquet")
```

## Dataset details

A documentation of the vector file format (i.e.,
.gpkg files in gpkg/) can be found
[here](https://www.jcomm.info/index.php?option=com_oe&task=viewDocumentRecord&docID=4439). The column names are the same for files between 1968 and present, but in 2020 there was a shift in data formats and only some columns were retained.

- `E_CA` (Partial concentration of thickest ice): '', '1', '2', '3', '4', '5', '6', '7', '8', '9'
- `E_CB` (Partial concentration of second thickest ice): '', '1', '2', '3', '4', '5', '6', '7', '8', '9'
- `E_CC` (Partial concentration of the third thickest ice): '', '1', '2', '3', '4', '5', '6', '7', '8'
- `E_CD` (Stage of development of any remaining class of ice (corresponds to Sd): '', '1', '2', '3', '4', '5', '6'
- `E_CS`: '', '1', '10', '2', '3', '4', '5', '6', '7', '8', '9', '9+'
- `E_CT` (Total concentration): '', '0.', '1', '10', '2', '3', '4', '5', '6', '7', '8', '9', '9+'
- `E_FA` (Form of thickest ice): '', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'X'
- `E_FB` (Form of second thickest ice): '', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'X'
- `E_FC` (Form of third thickest ice): '', '0', '1', '2', '3', '4', '5', '6', '7', '8', 'X'
- `E_FD` (Form of any remaining class of ice): ''
- `E_FE`: ''
- `E_SA` Stage of development of thickest ice): '', '1', '1.', '3', '4', '4.', '5', '6', '7', '7.', '8.', '9.'
- `E_SB` (Stage of development of second thickest Ice): '', '1', '1.', '2', '4', '4.', '5', '6', '7', '7.', '8.', 'X'
- `E_SC` (Stage of development of third thickest Ice): '', '1', '1.', '2', '3', '4', '4.', '5', '7'
- `E_SD` (Stage of development of any remaining class of ice): '', '1', '4', '4.', '5', '7'
- `E_SE`: ''
- `E_SO`: '', '1.', '4', '4.', '5', '6', '7', '7.', '8.', '9.'
- `N_CB`: '', ' 0.2', '10.0'
- `N_CFY`: '', ' 0.0', ' 0.3', ' 1.0', ' 1.3', ' 2.0', ' 2.3', ' 3.0', ' 3.3', ' 4.0', ' 4.3', ' 5.0', ' 5.3', ' 6.0', ' 6.3', ' 7.0', ' 7.3', ' 8.0', ' 8.3', ' 9.0', ' 9.3', ' 9.7', '10.0'
- `N_CG`: '', ' 0.0', ' 0.3', ' 1.0', ' 2.0', ' 3.0', ' 4.0', ' 5.0', ' 6.0', ' 7.0', ' 8.0', ' 9.0', ' 9.7', '10.0'
- `N_CGW`: '', ' 0.0', ' 0.3', ' 1.0', ' 2.0', ' 3.0', ' 4.0', ' 5.0', ' 6.0', ' 7.0', ' 8.0', ' 9.0', ' 9.7', '10.0'
- `N_CMY`: '', ' 0.0', ' 0.3', ' 1.0', ' 2.0', ' 3.0', ' 4.0', ' 5.0', ' 6.0', ' 7.0', ' 8.0', ' 9.0', ' 9.7', '10.0'
- `N_CN`: '', ' 0.0', ' 0.3', ' 1.0', ' 2.0', ' 3.0', ' 4.0', ' 5.0', ' 6.0', ' 7.0', ' 8.0', ' 9.0', ' 9.7', '10.0'
- `N_COI`: '', ' 0.0', ' 0.3', ' 0.6', ' 1.0', ' 1.3', ' 2.0', ' 2.3', ' 3.0', ' 3.3', ' 4.0', ' 4.3', ' 5.0', ' 5.3', ' 6.0', ' 6.3', ' 7.0', ' 7.3', ' 8.0', ' 8.3', ' 9.0', ' 9.3', ' 9.7', '10.0'
- `N_CSY`: '', ' 0.0', ' 0.3', ' 1.0', ' 2.0', ' 3.0', ' 4.0', ' 5.0', ' 6.0', ' 7.0', ' 8.0', ' 9.0', ' 9.7', '10.0'
- `N_CT`: '', ' 0.0', ' 0.2', ' 0.3', ' 1.0', ' 2.0', ' 3.0', ' 4.0', ' 5.0', ' 6.0', ' 7.0', ' 8.0', ' 9.0', ' 9.7', '10.0'
- `N_CYI`: '', ' 0.0', ' 0.3', ' 0.6', ' 1.0', ' 1.3', ' 2.0', ' 2.3', ' 3.0', ' 3.3', ' 4.0', ' 4.3', ' 5.0', ' 5.3', ' 6.0', ' 6.3', ' 7.0', ' 7.3', ' 8.0', ' 8.3', ' 9.0', ' 9.3', ' 9.7', '10.0'
- `R_CFY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_CG`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_CGW`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_CMY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_CN`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_CS`: '', ' 1', ' 2', ' 3', ' 4', ' 5', ' 6', ' 7', ' 8', ' 9', '10', '9+'
- `R_CSY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_CT`: '', ' 1', ' 2', ' 3', ' 4', ' 5', ' 6', ' 7', ' 8', ' 9', '10', '4', '9+'
- `R_PFY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_PG`: '', '/', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_PGW`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_PMY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_PN`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_PSY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_SFY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_SG`: '', '/', '0', '1', '2', '3', '4', '5', '6'
- `R_SGW`: '', '/', '0', '1', '2', '3', '5', '6'
- `R_SMY`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', 'F'
- `R_SN`: '', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'F'
- `R_SSY`: '', '/', '0', '1', '2', '3', '4', '6', 'F'

```{r, eval = FALSE}
attrs <- arrow::read_parquet("attrs.parquet")
colnames(attrs)

attrs %>% 
  select(matches("^[A-Z]_[A-Z]{2,3}$")) %>% 
  pivot_longer(everything()) %>% 
  distinct(name, value) %>% 
  arrange(name, value) %>% 
  group_by(name) %>% 
  summarise(
    values = paste0("'", value, "'", collapse = ", ")
  ) %>% 
  with(glue::glue("- `{ name }`: { values }")) %>% 
  glue::glue_collapse("\n") -> thing
```
